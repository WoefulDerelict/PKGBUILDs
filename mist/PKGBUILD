# Maintainer: Afri 5chdn <aur@cach.co>
# Contributor: Andy Weidenbaum <archbaum@gmail.com>

pkgname=mist
pkgver=0.8.1
_pkgver=${pkgver//./-}
pkgrel=1
pkgdesc="The Ethereum browser."
arch=('i686' 'x86_64')
url="https://github.com/ethereum/mist"
license=('GPL3')
depends=('gconf'
         'gmp'
         'leveldb'
         'qt5-base'
         'qt5-declarative'
         'qt5-quickcontrols'
         'qt5-webengine'
         'readline')
makedepends=('gendesk' 'setconf')
optdepends=('ethereum: The cpp-ethereum commandline client.')
provides=("${pkgname}")
conflicts=("${pkgname}-git")
source=("${pkgname}.png")
sha512sums=('a5b3b675e713b6b7bf00008ec784495b268d8a18061d57f9a1a58a8f18cb1c0904b602d9d31b59d8b2be1c3afb92284bfb6fc5cc6c35650e5a0b3dffaa0211af')
sha512sums_i686=('e58305a681cb0e46c5e56b84975b76996e2900504cba7f971dbfd7241043cd20e984b22718a579e6759276040462749af82ef4281fc15979a7f810e979b4d79e')
sha512sums_x86_64=('8ac5effcd007920bc66467adc023bb30cd241fa0488ca5a84db6819632709cbf5a4ded849aa6d8d56193772c12b5bafafe3b33f6b03d18270dd7a4c97ac889ca')
source_i686=("${pkgname}-${_pkgver}-32.zip::https://github.com/ethereum/${pkgname}/releases/download/${pkgver}/Ethereum-Wallet-linux32-${_pkgver}.zip")
source_x86_64=("${pkgname}-${_pkgver}-64.zip::https://github.com/ethereum/${pkgname}/releases/download/${pkgver}/Ethereum-Wallet-linux64-${_pkgver}.zip")

package() {
  _arch="32"
  if [ "${CARCH}" = "x86_64" ]; then
    _arch="64"
  fi

  [ -f mist.desktop ] && rm mist.desktop
  gendesk $startdir/PKGBUILD
  # Set the name and path
  setconf "${pkgname}.desktop" Name "Mist Browser"
  setconf -a "${pkgname}.desktop" Path "/usr/lib/mist"

  install -d "${pkgdir}/usr/lib/${pkgname}"
  cp -a "${srcdir}/Ethereum-Wallet-linux${_arch}-${_pkgver}/." "${pkgdir}/usr/lib/${pkgname}"

  install -d "${pkgdir}/usr/share/pixmaps"
  install -Dm644 "${srcdir}/${pkgname}.png" "${pkgdir}/usr/share/pixmaps"
  
  install -d "${pkgdir}/usr/share/applications"
  install -Dm644 "${srcdir}/${pkgname}.desktop" "${pkgdir}/usr/share/applications"

  install -d "${pkgdir}/usr/bin"
  ln -s "/usr/lib/${pkgname}/Ethereum-Wallet" "${pkgdir}/usr/bin/mist"
  ln -s "/usr/lib/${pkgname}/resources/node/geth/geth" "${pkgdir}/usr/bin/geth"

  install -d "${pkgdir}/usr/lib"
  ln -s "/usr/lib/${pkgname}/libnode.so" "${pkgdir}/usr/lib/libnode.so"

  ln -sf "/usr/lib/libgcrypt.so.11" "${pkgdir}/usr/lib/${pkgname}/libgcrypt.so.11"
  ln -sf "/usr/lib/libnotify.so.4" "${pkgdir}/usr/lib/${pkgname}/libnotify.so.4"

  rm "${pkgdir}/usr/lib/${pkgname}/LICENSE"

  find "${pkgdir}" -type d -exec chmod 755 {} +
  find "${pkgdir}" -type f -exec chmod 644 {} +
  chmod 755 "${pkgdir}/usr/lib/${pkgname}/Ethereum-Wallet"
  chmod 755 "${pkgdir}/usr/lib/${pkgname}/libnode.so"
  chmod 755 "${pkgdir}/usr/lib/${pkgname}/resources/node/geth/geth"
}
