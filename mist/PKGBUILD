# Maintainer: Afri 5chdn <aur@cach.co>
# Contributor: Andy Weidenbaum <archbaum@gmail.com>

pkgname=mist
pkgver=0.8.2
_pkgver=${pkgver//./-}
pkgrel=1
pkgdesc="The Ethereum browser."
arch=('i686' 'x86_64')
url="https://github.com/ethereum/mist"
license=('GPL3')
depends=('gconf'
         'gmp'
         'leveldb'
         'qt5-base'
         'qt5-declarative'
         'qt5-quickcontrols'
         'qt5-webengine'
         'readline')
makedepends=('gendesk' 'setconf')
optdepends=('parity: The fast, light, robust Ethereum client.')
provides=("${pkgname}")
conflicts=("${pkgname}-git")
source=("${pkgname}.png")
sha512sums=('a5b3b675e713b6b7bf00008ec784495b268d8a18061d57f9a1a58a8f18cb1c0904b602d9d31b59d8b2be1c3afb92284bfb6fc5cc6c35650e5a0b3dffaa0211af')
sha512sums_i686=('914b50fe87821d5110935a2293f04b4c144f66ec1c1d7f0b9a2c5d581a1faa98de8a1bb2d93ba7911008d0d277e434b72a7b80fa2682abb2949d0ea1c2a659d6')
sha512sums_x86_64=('8429009efdd59821944aa511e6c5c2c3e48ca7b7f254fcefb48ca366a75d3c331bd99f03fa03e82a71be573187b760c2beffbfeb5fbb7d7325930e1c74d1a401')
source_i686=("${pkgname}-${_pkgver}-32.zip::https://github.com/ethereum/${pkgname}/releases/download/${pkgver}/Ethereum-Wallet-linux32-${_pkgver}.zip")
source_x86_64=("${pkgname}-${_pkgver}-64.zip::https://github.com/ethereum/${pkgname}/releases/download/${pkgver}/Ethereum-Wallet-linux64-${_pkgver}.zip")

package() {
  _arch="32"
  if [ "${CARCH}" = "x86_64" ]; then
    _arch="64"
  fi

  [ -f mist.desktop ] && rm mist.desktop
  gendesk $startdir/PKGBUILD
  # Set the name and path
  setconf "${pkgname}.desktop" Name "Mist Browser"
  setconf -a "${pkgname}.desktop" Path "/usr/lib/mist"

  install -d "${pkgdir}/usr/lib/${pkgname}"
  cp -a "${srcdir}/Ethereum-Wallet-linux${_arch}-${_pkgver}/." "${pkgdir}/usr/lib/${pkgname}"

  install -d "${pkgdir}/usr/share/pixmaps"
  install -Dm644 "${srcdir}/${pkgname}.png" "${pkgdir}/usr/share/pixmaps"
  
  install -d "${pkgdir}/usr/share/applications"
  install -Dm644 "${srcdir}/${pkgname}.desktop" "${pkgdir}/usr/share/applications"

  install -d "${pkgdir}/usr/bin"
  ln -s "/usr/lib/${pkgname}/Ethereum-Wallet" "${pkgdir}/usr/bin/mist"
  ln -s "/usr/lib/${pkgname}/resources/node/geth/geth" "${pkgdir}/usr/bin/geth"

  install -d "${pkgdir}/usr/lib"
  ln -s "/usr/lib/${pkgname}/libnode.so" "${pkgdir}/usr/lib/libnode.so"

  ln -sf "/usr/lib/libgcrypt.so.11" "${pkgdir}/usr/lib/${pkgname}/libgcrypt.so.11"
  ln -sf "/usr/lib/libnotify.so.4" "${pkgdir}/usr/lib/${pkgname}/libnotify.so.4"

  rm "${pkgdir}/usr/lib/${pkgname}/LICENSE"

  find "${pkgdir}" -type d -exec chmod 755 {} +
  find "${pkgdir}" -type f -exec chmod 644 {} +
  chmod 755 "${pkgdir}/usr/lib/${pkgname}/Ethereum-Wallet"
  chmod 755 "${pkgdir}/usr/lib/${pkgname}/libnode.so"
  chmod 755 "${pkgdir}/usr/lib/${pkgname}/resources/node/geth/geth"
}
